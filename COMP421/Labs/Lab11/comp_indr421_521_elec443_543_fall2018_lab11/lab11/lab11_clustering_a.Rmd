---
title: 'Lab11: Clustering'
author: "Mehmet GÃ¶nen"
date: "December 10, 2018"
output: html_document
runtime: shiny
---

```{r, echo=FALSE}
library(MASS)

X <<- NULL
centroids <<- NULL
assignments <<- NULL

inputPanel(
  selectInput("sample_number", label = "Number of samples", choices = 50 * (1:20), selected = 500),
  selectInput("cluster_number", label = "Number of clusters", choices = 2:12, selected = 4)
)
inputPanel(
  actionButton("initialize_data", label = "Initialize data"),
  actionButton("update_centroids", label = "Update centroids"),
  actionButton("update_memberships", label = "Update memberships")
)

observeEvent(input$initialize_data, 
  {
    centroids <<- NULL
    assignments <<- NULL
    N <- as.numeric(input$sample_number)
    X1 <- mvrnorm(round(N / 4), c(+2, +2), matrix(c(.4, 0, 0, .4), 2, 2))
    X2 <- mvrnorm(round(N / 4), c(-2, +2), matrix(c(.4, 0, 0, .4), 2, 2))
    X3 <- mvrnorm(round(N / 4), c(+2, -2), matrix(c(.4, 0, 0, .4), 2, 2))
    X4 <- mvrnorm(round(N / 4), c(-2, -2), matrix(c(.4, 0, 0, .4), 2, 2))
    X <- rbind(X1, X2, X3, X4)
    X <<- scale(X)
  }
)

observeEvent(input$update_centroids,
  {
    N <- as.numeric(input$sample_number)
    K <- as.numeric(input$cluster_number)
    if (is.null(centroids) == TRUE) {
      centroids <- X[sample(1:N, K),]
    } 
    else {
      for (k in 1:K) {
        centroids[k,] <- colMeans(X[assignments == k,])
      }  
    }
    centroids <<- centroids
  }
)

observeEvent(input$update_memberships,
  {
    D <- as.matrix(dist(rbind(centroids, X), method = "euclidean"))
    D <- D[1:nrow(centroids), (nrow(centroids) + 1):(nrow(centroids) + nrow(X))]
    assignments <<- sapply(1:ncol(D), function(i) {which.min(D[,i])})
  }
)

renderPlot({
  input$sample_number
  input$cluster_number
  input$initialize_data
  input$update_centroids
  input$update_memberships
  colors <- c("#1f78b4", "#33a02c", "#e31a1c", "#ff7f00", "#6a3d9a", "#b15928", "#a6cee3", "#b2df8a", "#fb9a99", "#fdbf6f", "#cab2d6", "#ffff99")
  if (is.null(X) == FALSE && is.null(assignments) == TRUE) {
    par(mar = c(0, 0, 0, 0), oma = c(0, 0, 0, 0))
    plot(X[,1], X[,2], col = "lightgray", xlim = c(-2, 2), ylim = c(-2, 2), xlab = "", ylab = "", cex = 1.5, axes = FALSE, pch = 19)
  }
  if (is.null(X) == FALSE && is.null(assignments) == FALSE) {
    par(mar = c(0, 0, 0, 0), oma = c(0, 0, 0, 0))
    plot(X[,1], X[,2], col = colors[assignments], xlim = c(-2, 2), ylim = c(-2, 2), xlab = "", ylab = "", cex = 1.5, axes = FALSE, pch = 19)
  }
  if (is.null(centroids) == FALSE) {
    points(centroids[,1], centroids[,2], col = "black", pch = 19, cex = 3) 
  }
}, height = 1000, width = 1000)
```